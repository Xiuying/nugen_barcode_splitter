#!/usr/bin/env ruby
require "rubygems"
require "yaml"
require "optparse"

usage =<<EOF
      #{$0} [options] -p project_dir -o out_dir -c sample_sheet_nugen
_____________________________________________________________________________

      Example sample_sheet_nugen.csv :

FCID,Lane,SampleID,SampleRef,Index,Description,Control,Recipe,Operator,SampleProject
C0ED3ACXX,4,S1,hg19,ACCC,RNA Seq,N,,,33333
C0ED3ACXX,4,S2,hg19,GAGT,RNA Seq,N,,,44444
C0ED3ACXX,4,S3,hg19,CGTA,RNA Seq,N,,,33333
C0ED3ACXX,4,S4,hg19,TTAG,RNA Seq,N,,,44444
C0ED3ACXX,5,S5,hg19,AGGG,RNA Seq,N,,,33333
C0ED3ACXX,5,S6,hg19,GTCA,RNA Seq,N,,,44444
C0ED3ACXX,6,S7,hg19,CCAT,RNA Seq,N,,,33333

      Note: The sample names must be alphanumerical!
_____________________________________________________________________________

EOF

options = {
  :project_dir => nil,
  :out_dir => nil,
  :sample_sheet => nil,
  :eol_only? => false,
  :bel_only? => false,
  :mismatches => 1,
  :keep_barcode => false
}

optparse = OptionParser.new do |opts|
  opts.banner = usage

  opts.on("-p", "--project_dir", :REQUIRED, String,
    "Illumina project directory (../Unaligned/ProjectXXX/)") do |i|
    options[:project_dir] = i if i
  end

  opts.on("-o", "--out_dir", :REQUIRED, String,
    "The desired output directory") do |i|
    options[:out_dir] = i if i
  end

  opts.on("-s","--sample_sheet", :REQUIRED, String,
    "Please provide your sample_sheet") do |i|
    options[:sample_sheet] = i if i
  end

  opts.on("-e","--end_of_line",
    "Limit the search for the barcode to the end of the line DEFAULT:false") do |i|
    options[:eol_only?] = true
  end

  opts.on("-b","--begin_of_line",
    "Limit the search for the barcode to the start of the line DEFAULT:false") do |i|
    options[:bol_only?] = true
  end

  opts.on("-k","--keep_barcode",
    "Do not trim of the barcode DEFAULT:false") do |i|
    options[:keep_barcode] = false
  end

  opts.on("-m","--mismatches NUM", Integer) do |i|
    options[:mismatches] = i if i
  end

  opts.on_tail("-h", "--help", "Show this message") do
    puts opts
    exit
  end
end

begin
  optparse.parse!
  mandatory = [:project_dir, :out_dir, :barcode]
  missing = mandatory.select{ |param| options[param].nil? }
  if !missing.empty?
    puts "\nMissing options given or missing in config_file: \n\t#{missing.join(",\n\t")}"
    puts optparse
    exit
  end
rescue OptionParser::InvalidOption, OptionParser::MissingArgument
   puts $!.to_s
   puts optparse
   exit
end

STDERR.puts "CURRENT OPTIONS:"
STDERR.puts options.to_yaml

# Read out sample_sheet
sample_sheet = SampleSheet.new(options[:sample_sheet])
